<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Generation - PM Poshan Portal</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>PM Poshan Portal</h2>
        <p>Administrator Dashboard</p>
      </div>
      
      <nav>
        <ul>
          <li><a href="{% url 'admin_dashboard' %}" class="active">Dashboard</a></li>
          <li><a href="{% url 'bill_approval' %}">Approve Bills</a></li>
          <li><a href="{% url 'grant_allocation' %}">Allocate Grants</a></li>
          <li><a href="{% url 'report' %}">Generate Reports</a></li>
          <li><a href="{% url 'organization' %}">Manage Organizations</a></li>
          <li><a href="{% url 'admin_notifications' %}">Notifications</a></li>
        </ul>
      </nav>
      <div style="padding: 20px;">
        <button id="logout-btn" class="btn-secondary">Logout</button>
      </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
      <header>
        <h1>Report Generation</h1>
        <p>Generate and download various reports</p>
      </header>
      
      <div class="form-container">
        <h2>Generate Report</h2>
        
        <form id="report-form" method="POST" action="{% url 'report' %}">
          {% csrf_token %}
          <div class="form-group">
            <label for="report-type">Report Type</label>
            <select id="report-type" name="report_type" required>
              <option value="">Select report type</option>
              <option value="mis">MIS Report</option>
              <option value="monthly">Monthly Patrak</option>
              <option value="expenditure">Expenditure Report</option>
              <option value="allocation">Grant Allocation Report</option>
              <option value="summary">Summary Report</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="organization">Organization</label>
            <select id="organization" name="organization">
                <option value="all">All Organizations</option>
                {% for org in organizations %}
                    <option value="{{ org.id }}">{{ org.organization_name }}</option>
                {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="start-date">Start Date</label>
            <input type="date" id="start-date" name="start_date" required>
          </div>
          
          <div class="form-group">
            <label for="end-date">End Date</label>
            <input type="date" id="end-date" name="end_date" required>
          </div>
          
          <div class="form-group">
            <label for="report-format">Report Format</label>
            <select id="report-format" name="report_format" required>
              <option value="pdf">PDF</option>
              <option value="excel">Excel</option>
              <option value="csv">CSV</option>
            </select>
          </div>
          
          <div class="form-actions">
            <button type="reset" class="btn-secondary">Reset</button>
            <button type="submit" class="btn-primary">Generate Report</button>
          </div>
        </form>
        
        <h2 style="margin-top: 40px;">Recent Reports</h2>
        <div class="rounded-md border" style="margin-top: 20px;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f6f7f9;">
                <th style="padding: 10px; text-align: left;">Report Name</th>
                <th style="padding: 10px; text-align: left;">Generated On</th>
                <th style="padding: 10px; text-align: left;">Generated By</th>
                <th style="padding: 10px; text-align: left;">Format</th>
              </tr>
            </thead>
            <tbody>
              {% for report in recent_reports %}
              <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 10px;">{{ report.report_name }}</td>
                <td style="padding: 10px;">{{ report.generated_on }}</td>
                <td style="padding: 10px;">{{ report.generated_by.username }}</td>
                <td style="padding: 10px;">{{ report.get_report_format_display }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="4" style="padding: 10px; text-align: center;">No reports generated yet.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SweetAlert for Notifications -->
   
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="{% static 'js/api.js' %}"></script>
  <script src="{% static 'js/script.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const reportForm = document.getElementById("report-form");

    reportForm.addEventListener("submit", function (event) {
      event.preventDefault(); // Prevent default form submission

      const reportType = document.getElementById("report-type").value;
      const organization = document.getElementById("organization").value;
      const startDate = document.getElementById("start-date").value;
      const endDate = document.getElementById("end-date").value;
      const reportFormat = document.getElementById("report-format").value;

      // Form validation
      if (!reportType || !startDate || !endDate || !reportFormat) {
        Swal.fire("⚠️ Missing Fields", "Please fill in all required fields.", "warning");
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        Swal.fire("⚠️ Invalid Dates", "Start date cannot be after the end date.", "warning");
        return;
      }

      // Submit form data using Fetch API
      const formData = new FormData(reportForm);
      fetch(reportForm.action, {
        method: "POST",
        body: formData,
        headers: {
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error("Server error");
        }
        return response.blob(); // Convert response to a blob
      })
      .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `report.${reportFormat}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        Swal.fire("✅ Success", "Report generated successfully!", "success");
        reportForm.reset(); // Reset the form
      })
      .catch(error => {
        console.error("Error:", error);
        Swal.fire("❌ Error", "Failed to generate report.", "error");
      });
    });
  });
</script>

</body>
</html>
